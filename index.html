<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Some Foods</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet"/>
  <style>
    #map { height: 400px; width: 100%; }
    @media (max-width: 576px) {
      #map { height: 300px; }
    }
    #results { margin-top: 10px; }
    .restaurant { margin: 5px 0; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">üçΩÔ∏è Eater</h1>

    <div class="row g-3 mb-3">
      <div class="col-sm-6 col-md-4">
        <input type="text" id="keyword" class="form-control" placeholder="Enter restaurant name">
      </div>
      <div class="col-sm-4 col-md-3">
        <select id="rating" class="form-select">
          <option value="3">‚≠ê 3 stars or above</option>
          <option value="4">‚≠ê 4 stars or above</option>
          <option value="4.5">‚≠ê 4.5 stars or above</option>
          <option value="5">‚≠ê 5 stars or above</option>
        </select>
      </div>
      <div class="col-sm-2 d-grid">
        <button class="btn btn-primary" onclick="searchPlaces()">Search</button>
      </div>
      <div class="col-sm-12 col-md-3 d-grid">
        <button class="btn btn-success" onclick="searchRandom()">Whatever lah üé≤</button>
      </div>
    </div>

    <div id="map" class="mb-3"></div>
    <ul id="results" class="list-group"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let map, userPos, service;

    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userPos = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            };

            map = new google.maps.Map(document.getElementById("map"), {
              center: userPos,
              zoom: 15
            });

            new google.maps.Marker({
              position: userPos,
              map: map,
              label: "You"
            });

            // ÂàùÂßãÂåñ PlacesService
            service = new google.maps.places.PlacesService(map);
          },
          () => { alert("Failed to get your location"); }
        );
      } else {
        alert("Geolocation is not supported by your browser");
      }
    }

    function searchPlaces() {
      const rating = parseFloat(document.getElementById("rating").value);

      const request = {
        location: new google.maps.LatLng(userPos.lat, userPos.lng), // ‰øÆÊ≠£
        radius: 3000,
        type: ["restaurant"]
      };

      service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          const filtered = results.filter(place => place.rating >= rating);

          if (filtered.length === 0) {
            Swal.fire("No restaurants found nearby!", "Try lowering the rating filter.", "warning");
            return;
          }

          displayResults(filtered);
        } else {
          console.error("Error searching restaurants:", status);
          Swal.fire("Search failed", "Please try again later.", "error");
        }
      });
    }

    function searchRandom() {
      const rating = parseFloat(document.getElementById("rating").value);

      const request = {
        location: new google.maps.LatLng(userPos.lat, userPos.lng),
        radius: 3000,
        type: ["restaurant"]
      };

      service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          const filtered = results.filter(place => place.rating >= rating);

          if (filtered.length === 0) {
            Swal.fire("No restaurants match your criteria!", "Try lowering the rating filter.", "warning");
            return;
          }

          const randomIndex = Math.floor(Math.random() * filtered.length);
          const randomPlace = filtered[randomIndex];
          displayResults([randomPlace]);

          Swal.fire({
            title: "Today's Pick üéâ",
            html: `<b>${randomPlace.name}</b><br>‚≠ê Rating: ${randomPlace.rating || "N/A"}<br>üìç ${randomPlace.vicinity || ""}`,
            icon: "success",
            showCancelButton: true,
            confirmButtonText: "Navigate",
            cancelButtonText: "Cancel"
          }).then((result) => {
            if (result.isConfirmed) {
              const url = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${randomPlace.geometry.location.lat()},${randomPlace.geometry.location.lng()}&travelmode=driving`;
              window.open(url, "_blank");
            }
          });

        } else {
          console.error("Error picking random restaurant:", status);
          Swal.fire("Recommendation failed", "Please try again later.", "error");
        }
      });
    }

    function displayResults(places) {
      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      const bounds = new google.maps.LatLngBounds();

      places.forEach((place) => {
        const div = document.createElement("div");
        div.className = "restaurant";
        div.innerHTML = `<strong>${place.name}</strong><br>Rating: ${place.rating || "N/A"}<br>Address: ${place.vicinity || "N/A"}`;
        resultsDiv.appendChild(div);

        new google.maps.Marker({
          position: place.geometry.location,
          map: map,
          title: place.name
        });

        bounds.extend(place.geometry.location);
      });

      map.fitBounds(bounds);
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7JiHggis66nCLaEszgv4Np_YVL4t9qVI&libraries=places&callback=initMap">
  </script>
</body>
</html>
